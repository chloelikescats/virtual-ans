{% extends 'base.html' %}
{% block head %}
{% endblock %}

{% block content %}

<!-- Play button in ANS interface sends img_id to route that gets pixel data and passes to JavaScript -->
<div>
    <img src="/static/images/black.png" id="queue" height="360px">
<form id="play">
    <input type="hidden" id="img_id_in" name="img_id">
    <input type="submit" value="Play">
</form>
</div>

<br>
<br>
<form action="/process-image" enctype="multipart/form-data" method="POST">
    <input type="file" name ="pic" accept="image/*"/>
    <br>
    <input type="radio" name="privacy" value="private">Private
    <input type="radio" name="privacy" value="public">Public
    <br>
    <input type="submit"/>
</form>
<br>


<!-- Playable images (pre-analyzed) -->
<div id="images">
    {% for img in imgs %}
    <img src={{ img.img_url }} class="playables" id={{ img.img_id }} height="200px">
    {% endfor %}
</div>

<script>
    $('.playables').on('click', function() {
        //get image id, load image in interface, pass image id to hidden input
        let queueImg = document.querySelector("#queue");
        let getSrc = $(this).attr("src")
        queueImg.setAttribute('src', getSrc);
        let imgId = $(this).attr("id");
        $("#img_id_in").val(imgId);
    });
</script>

<!-- *********************************************************************** -->
<!-- Canvas -->
<br>
<div>
    <canvas id="canvas" width="240" height="360" style="border:1px solid #000000; background-color: black;"></canvas>

    <p class="toolList">
        <button id="clearCanvas" type="button">Clear</button>
        <button id="pen" type="button">Pen</button>
        <button id="eraser" type="button">Eraser</button>
        <button id="saveCanvas" type="button">Save/Play</button>
    </p>
</div>

<script>
context = document.getElementById('canvas').getContext("2d");
context.fillStyle="black";
let colorBlack = "black";
let colorWhite = "white";
let curColor = colorWhite;
let clickX = new Array();
let clickY = new Array();
let clickDrag = new Array();
let clickColor = new Array;
let paint;

$('#canvas').mousedown(function(e){
  let mouseX = e.pageX - this.offsetLeft;
  let mouseY = e.pageY - this.offsetTop;
        
  paint = true;

  addClick(e.pageX - this.offsetLeft, e.pageY - this.offsetTop, false, curColor);
  redraw();
});

$('#canvas').mousemove(function(e){
  if(paint){
    addClick(e.pageX - this.offsetLeft, e.pageY - this.offsetTop, true, curColor);

    redraw();
  }
});

$('#canvas').mouseup(function(e){
  paint = false;
});

$('#canvas').mouseleave(function(e){
  paint = false;
});

function addClick(x, y, dragging, color){
  clickX.push(x);
  clickY.push(y);
  clickDrag.push(dragging);
  clickColor.push(color);
}

function redraw(){
  context.lineJoin = "square";
  context.lineWidth = 5;
            
  for(let i=0; i < clickX.length; i++) {        
    context.beginPath();
    if(clickDrag[i] && i){
      context.moveTo(clickX[i-1], clickY[i-1]);
     }else{
       context.moveTo(clickX[i]-1, clickY[i]);
     }
     context.strokeStyle = clickColor[i];
     context.lineTo(clickX[i], clickY[i]);
     context.stroke();
     context.closePath();
  }
}

// ***************************************************************** 
// Event Listeners:

// Clear Canvas:
document.getElementById('clearCanvas').addEventListener('click', function(){
    context.clearRect(0, 0, context.canvas.width, context.canvas.height); 
    clickX = new Array();
    clickY = new Array();
    clickDrag = new Array();
    context.beginPath();
});

// Select Eraser Tool:
document.getElementById('eraser').addEventListener('click', function() {
    curColor = colorBlack;
});

// Select Pen Tool:
document.getElementById('pen').addEventListener('click', function() {
    curColor = colorWhite;
});


// Save Canvas (get URL to pass to app route):
document.getElementById('saveCanvas').addEventListener('click', function(){
    let canvas = document.getElementById('canvas');
        let dataUrl = canvas.toDataURL('image/jpeg');
        let blobBin = atob(dataUrl.split(',')[1]);
        let array = [];
        for (let i = 0; i <blobBin.length; i++) {
            array.push(blobBin.charCodeAt(i));
        }

        let file = new Blob([new Uint8Array(array)], {type: 'image/jpg'});

        let formData = new FormData();
        formData.append("myFileName", file);


        $.ajax({
            type: 'POST',
            url: '/process-canvas',
            data: formData,
            contentType: false,
            processData: false,
            success: playSynths
        });
});
</script>


<script src="/static/js/flocking/flocking-all.js"></script>
<script src="/static/js/virtual_ans.js"></script>
{% endblock %}